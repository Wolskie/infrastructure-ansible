---

- set_fact:
    ignition_source: https://hahl-infra-ignition.s3.us-west-000.backblazeb2.com/infra/
    bootstrap:
      - { name: "syd-bootstrap-01.infra.hahl.id.au" }
    masters:
      - { name: "syd-master-01.infra.hahl.id.au" }
      - { name: "syd-master-02.infra.hahl.id.au" }
      - { name: "syd-master-03.infra.hahl.id.au" }
    workers:
      - { name: "syd-worker-01.infra.hahl.id.au" }
      - { name: "syd-worker-02.infra.hahl.id.au" }
      - { name: "syd-worker-03.infra.hahl.id.au" }

- openstack.cloud.server:
    state: present
    name: "{{item.name}}"
    image: "rhcos-4.9.0-x86_64"
    boot_from_volume: true
    volume_size: 120
    key_name: "openshift-aio"
    auto_ip: false
    flavor: "okd.node"
    config_drive: true
    security_groups:
      - "#open"
    nics:
      - "port-name={{item.name}}_Port-1"
    meta: "hostname={{item.name}},network=k8s,role=bootstrap"
    userdata: |
      {
        "ignition": {
          "config": {
            "merge": [
              {
                "source": "{{ignition_source}}/bootstrap.ign"
              }
            ]
          },
          "storage": {
              "files": [{
                "path": "/etc/hostname",
                "mode": 420,
                "overwrite": true,
                "contents": { "source": "data:,{{item.name}}" }
              }],
          },
          "version": "3.2.0"
      }
  with_items: "{{bootstrap}}"

- openstack.cloud.server:
    state: present
    name: "{{item.name}}"
    image: "rhcos-4.9.0-x86_64"
    boot_from_volume: true
    volume_size: 120
    config_drive: true
    key_name: "openshift-aio"
    auto_ip: false
    flavor: "okd.node"
    security_groups:
      - "sg-allow_internet"
      - "sg-role-ssh_server"
      - "sg-role-idm_client"
      - "sg-role-k8s_master"
      - "sg-role-apps_lb_backend_https"
      - "sg-role-k8s_client"
    nics:
      - "port-name={{item.name}}_Port-1"
    meta: "hostname={{item.name}},network=k8s,role=kubernetes"
    userdata: |
      {
        "ignition": {
          "config": {
            "merge": [
              {
                "source": "{{ignition_source}}/master.ign"
              }
            ]
          },
          "storage": {
              "files": [{
                "path": "/etc/hostname",
                "mode": 420,
                "overwrite": true,
                "contents": { "source": "data:,{{item.name}}" }
              }],
          },
          "version": "3.2.0"
      }
  with_items: "{{masters}}"

- openstack.cloud.server:
    state: present
    name: "{{item.name}}"
    image: "rhcos-4.9.0-x86_64"
    boot_from_volume: true
    volume_size: 120
    config_drive: true
    key_name: "openshift-aio"
    auto_ip: false
    flavor: "okd.worker"
    volumes:
      - "{{item.name}}_Ceph_Disk-1"
    security_groups:
      - "sg-allow_internet"
      - "sg-role-prometheus"
      - "sg-role-ssh_server"
      - "sg-role-idm_client"
      - "sg-role-k8s_worker"
      - "sg-role-k8s_client"
      - "sg-role-apps_lb_backend_https"
    nics:
      - "port-name={{item.name}}_Port-1"
    meta: "hostname={{item.name}},network=infra-k8s,role=kubernetes"
    userdata: |
      {
        "ignition": {
          "config": {
            "merge": [
              {
                "source": "{{ignition_source}}/worker.ign"
              }
            ]
          },
          "storage": {
              "files": [{
                "path": "/etc/hostname",
                "mode": 420,
                "overwrite": true,
                "contents": { "source": "data:,{{item.name}}" }
              }],
          },
          "version": "3.2.0"
      }

  with_items: "{{workers}}"