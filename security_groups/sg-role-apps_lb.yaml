---

- set_fact:
    security_groups:
      - name: "sg-role-apps_lb_backend_https"
        rules: []

      - name: "sg-role-apps_lb_backend_mc"
        rules: []

      - name: "sg-role-apps_lb"
        description: Application loadbalancer.
        rules:
          # Incoming  HTTPS
          - { direction: "ingress", protocol: tcp, port: 80,   remote_ip_prefix: "0.0.0.0/0",  description: "All HTTP"  }
          - { direction: "ingress", protocol: tcp, port: 443,  remote_ip_prefix: "0.0.0.0/0",  description: "All HTTPS" }
          - { direction: "egress",  protocol: tcp, port: 80,   remote_group: "sg-role-apps_lb_backend_https", description: "https to backend" }
          - { direction: "egress",  protocol: tcp, port: 443,  remote_group: "sg-role-apps_lb_backend_https", description: "https to backend" }

          # Minecraft
          - { direction: "ingress", protocol: tcp, port: 25565,  remote_ip_prefix: "0.0.0.0/0",  description: "Minecraft" }
          - { direction: "egress", protocol: tcp, port: 25565, remote_group: "sg-role-apps_lb_backend_mc", description: "Minecraft" }

          # Keepalived VRRP
          - { direction: "ingress", protocol: 112, remote_group: "sg-role-apps_lb", description: "VRRP" }

- openstack.cloud.security_group:
    state: present
    name: "{{item.name}}"
    description: "{{item.description | default(omit)}}"
  with_items: "{{security_groups}}"

- openstack.cloud.security_group_rule:
    security_group: "{{item.name}}"
    protocol: any
    port_range_min: 0
    port_range_max: 65535
    remote_ip_prefix: 0.0.0.0/0
    state: absent
  with_items: "{{security_groups}}"

## Remove default rules

- openstack.cloud.security_group_rule:
    security_group: "{{item.name}}"
    protocol: any
    ethertype: "IPv4"
    direction: egress
    port_range_min: 0
    port_range_max: 65535
    remote_ip_prefix: 0.0.0.0/0
    state: absent
  with_items: "{{security_groups}}"

- openstack.cloud.security_group_rule:
    security_group: "{{item.name}}"
    protocol: any
    direction: egress
    ethertype: "IPv6"
    port_range_min: 0
    port_range_max: 65535
    remote_ip_prefix: "::/0"
    state: absent
  with_items: "{{security_groups}}"

## Apply Rules
- openstack.cloud.security_group_rule:
    security_group: "{{item.0.name}}" 
    protocol: "{{ item.1.protocol | default(tcp) }}"
    port_range_min: "{{ item.1.port | default(omit)}}"
    port_range_max: "{{ item.1.port | default (omit) }}"
    remote_ip_prefix: "{{item.1.remote_ip_prefix | default(omit)}}"
    remote_group: "{{item.1.remote_group | default(omit)}}"
  loop: "{{ security_groups | subelements('rules') }}"
